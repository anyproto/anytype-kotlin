on:
  schedule:
    - cron: '30 23 * * 1,2,3,4,5'
  workflow_dispatch:
    inputs:
      version_postfix:
        description: 'Custom postfix to append to version name (e.g., "feature-xyz" â†’ 1.2.3-18.02.26-feature-xyz)'
        required: false
        default: ''
        type: string
name: Distribute nightly debug build
jobs:
  setup-android:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-java@v3
        with:
          distribution: "zulu"
          java-version: 17

      - name: Setup middleware dependency
        env:
          token_secret: ${{ secrets.ANYTYPE_SECRET }}
          user_secret: ${{ secrets.ANYTYPE_USER_SECRET }}
          amplitude_secret: ${{ secrets.ANYTYPE_AMPLITUDE_SECRET }}
          amplitude_secret_debug: ${{ secrets.ANYTYPE_AMPLITUDE_DEBUG_SECRET }}
          sentry_dsn_secret: ${{ secrets.ANYTYPE_SENTRY_DSN_SECRET }}
        run: ./middleware2.sh $token_secret $user_secret $amplitude_secret $amplitude_secret_debug $sentry_dsn_secret

      - name: Enable analytics for nightly debug builds
        run: make enable_analytics_for_debug

      - name: Decrypt secrets
        run: ./scripts/distribution/decrypt-secrets.sh
        env:
            ENCRYPT_KEY: ${{ secrets.ENCRYPT_KEY_FIREBASE_DISTRIBUTION }}

      - name: Distribute debug build
        run: |
          if [ -n "${{ github.event.inputs.version_postfix }}" ]; then
            make distribute_debug_with_postfix POSTFIX="${{ github.event.inputs.version_postfix }}"
          else
            make distribute_debug
          fi

      - name: Clean secrets
        if: always()
        run: ./scripts/distribution/clean-secrets.sh